# ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø±Ø¨Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯Ø± Ø¢Ø¨ÛŒ Ø¯Ù„
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
import requests
import os

# ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø§Ø² Ù…Ø­ÛŒØ· Ø§Ù…Ù† Ø±ÛŒÙ¾Ù„ÛŒØª
TELEGRAM_TOKEN = os.getenv("8405364928:AAG1AeznfzqWU2an0umqKoehe1v2woe8G4s")
ADMIN_ID = os.getenv("https://t.me/esher2")

# Ù„ÛŒØ³Øª Ù¾ÛŒØ¬â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ ÙØ§Ù„Ùˆ Ø¨Ø´Ù†
REQUIRED_FOLLOW_LINKS = [
    {"title": "Ù¾ÛŒØ¬ Ø¢Ø¨ÛŒ Ø¯Ù„ ğŸ’™", "url": "https://www.instagram.com/abi_deell/"},
    {"title": "Ø§Ø´Ø¹Ø§Ø± Ø¯Ø§ÙˆÙˆØ¯ Ù…Ø­Ù…Ø¯Ú©ÛŒØ§ âœï¸", "url": "https://www.instagram.com/esher.official/"}
]

# ØªØ§Ø¨Ø¹ Ø´Ø±ÙˆØ¹ - Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù„ÛŒÙ¾ Ø§Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…", callback_data="download")],
        [InlineKeyboardButton("ğŸ“£ Ø¬Ø°Ø¨ ØªØ¨Ù„ÛŒØºØ§Øª", callback_data="ads")],
    ]
    for page in REQUIRED_FOLLOW_LINKS:
        keyboard.append([InlineKeyboardButton(f"âœ… ÙØ§Ù„Ùˆ Ú©Ù†: {page['title']}", url=page['url'])])
    await update.message.reply_text(
        "ğŸ‘‹ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯Ø± Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø¢Ø¨ÛŒ Ø¯Ù„ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\n\n"
        "ğŸ“Œ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù„ÛŒÙ†Ú© Ù¾Ø³ØªØŒ Ø±ÛŒÙ„Ø² ÛŒØ§ Ø§Ø³ØªÙˆØ±ÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø¨ÙØ±Ø³ØªÛŒØ¯ ØªØ§ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø± Ø§ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø· Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.\n"
        "ğŸ“Œ Ø§Ø² Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯ÙˆÙ… Ø¨Ù‡ Ø¨Ø¹Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ù¾ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ù…Ø§ Ø±Ø§ ÙØ§Ù„Ùˆ Ú©Ù†ÛŒØ¯.\n\n"
        "ğŸ“ Ø§Ø² Ù…Ù†Ùˆ Ú¯Ø²ÛŒÙ†Ù‡ Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == "download":
        await query.message.reply_text("Ù„Ø·ÙØ§Ù‹ Ù„ÛŒÙ†Ú© Ù¾Ø³Øª ÛŒØ§ Ø±ÛŒÙ„Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
        context.user_data["awaiting_link"] = True

    elif query.data == "ads":
        await query.message.reply_text(
            "ğŸ¯ Ø¨Ù‡ Ø¨Ø®Ø´ ØªØ¨Ù„ÛŒØºØ§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\n\n"
            "ØªØ¨Ù„ÛŒØº Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¬ Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒ 20 Ù‡Ø²Ø§Ø± ÙØ§Ù„ÙˆØ± Ø§ÛŒÙ†Ø·ÙˆØ±ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø§Ú¯Ø± Ø±Ø¨Ø§Øª Ù…Ø§ Ø±Ø§ Ù¾Ø³Øª Ú©Ù†ÛŒØ¯ØŒ Ù¾ÛŒØ¬ Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø± Ø±Ø¨Ø§Øª Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ… Ùˆ ÙØ§Ù„ÙˆØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ØŒ Ù…Ø¬Ø¨ÙˆØ± Ø¨Ù‡ ÙØ§Ù„Ùˆ Ø´Ù…Ø§ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯ Ùˆ Ø§Ù…Ø§ Ø§Ú¯Ø± ØªØ¨Ù„ÛŒØºØ§Øª Ù¾ÙˆÙ„ÛŒ Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø§ Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…ÛŒ @eshr2 Ù¾ÛŒØ§Ù… Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ ØªØ§ Ù…Ø°Ø§Ú©Ø±Ù‡ Ú©Ù†ÛŒÙ… .\n"
            "Ø¬Ù‡Øª Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒØŒ Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯: esher2@"
        )

# Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if context.user_data.get("awaiting_link"):
        context.user_data["awaiting_link"] = False
        url = update.message.text

        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù‡ ÛŒØ§ Ù†Ù‡
        user_id = update.effective_user.id
        downloads = context.bot_data.get("downloads", {})
        user_downloads = downloads.get(user_id, 0)

        if user_downloads >= 1:
            links = "\n".join([f"ğŸ”— {p['title']}: {p['url']}" for p in REQUIRED_FOLLOW_LINKS])
            await update.message.reply_text(
                f"âš ï¸ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø§ÛŒÙ† Ù¾ÛŒØ¬â€ŒÙ‡Ø§ Ø±Ø§ ÙØ§Ù„Ùˆ Ú©Ù†ÛŒØ¯:\n{links}"
            )
            return

        try:
            await update.message.reply_text("â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...")
            api = f"https://api.igdownloader.app/api/v1/download?url={url}"
            res = requests.get(api)
            data = res.json()

            if data.get("success"):
                for media in data["media"]:
                    file_url = media.get("url")
                    caption = media.get("title", "") + "\n" + media.get("hashtags", "")
                    if file_url.endswith(".mp4"):
                        await update.message.reply_video(file_url, caption=caption[:1024])
                    else:
                        await update.message.reply_photo(file_url, caption=caption[:1024])

                downloads[user_id] = user_downloads + 1
                context.bot_data["downloads"] = downloads
            else:
                await update.message.reply_text("âš ï¸ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾ÛŒØ´ Ø¢Ù…Ø¯.")
        except:
            await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
if __name__ == '__main__':
    app = Application.builder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()
